---
export const prerender = true;

import { I18nService } from '../../services/I18nService.js';
import { RichContentService } from '../../services/RichContentService.js';

export interface Props {
  key: string;
  fallback?: string;
  className?: string;
  sanitize?: boolean;
  maxLength?: number;
  tag?: keyof HTMLElementTagNameMap;
  theme?: 'light' | 'dark' | 'gold' | 'adaptive' | 'custom';
  [key: string]: any;
}

const { 
  key, 
  fallback, 
  className, 
  sanitize = false,
  maxLength,
  tag = 'div',
  theme = 'adaptive',
  ...restProps 
} = Astro.props;

const { locale } = I18nService.getI18nInfo(Astro);

function sanitizeHtml(html: string): string {
  if (!sanitize) return html;
  
  return html
    .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
    .replace(/<iframe\b[^<]*(?:(?!<\/iframe>)<[^<]*)*<\/iframe>/gi, '')
    .replace(/on\w+="[^"]*"/gi, '')
    .replace(/javascript:/gi, '');
}

const richContent = await RichContentService.getContentByLanguageAndKey(locale, "historia_content");
let html = richContent.contentValue;

if (sanitize) {
  html = sanitizeHtml(html);
}

if (maxLength && html.length > maxLength) {
  const tempDiv = { textContent: html.replace(/<[^>]*>/g, '') };
  if (tempDiv.textContent && tempDiv.textContent.length > maxLength) {
    html = html.substring(0, maxLength - 3) + '...';
  }
}

const elementProps = {
  class: `richtext-editor ${theme}-theme ${className || ''}`.trim(),
  ...restProps
};

const Element = tag;
---

<Element {...elementProps} set:html={html} />

<style>
  /* === MEJORAS DE RENDIMIENTO === */
  .richtext-editor {
    contain: layout style;
  }

  /* Títulos HTML estándar - usando :global para contenido inyectado con set:html */
  .richtext-editor :global(h1) {
    font-family: var(--rt-heading-font);
    font-size: clamp(var(--text-4xl), 4vw, var(--text-5xl));
    font-weight: var(--font-bold);
    line-height: var(--leading-tight);
    color: var(--rt-primary-color);
    margin: 0 0 var(--space-6) 0;
    letter-spacing: var(--tracking-tight);
    transition: var(--transition-colors);
  }

  .richtext-editor :global(h2) {
    font-family: var(--rt-heading-font);
    font-size: clamp(var(--text-3xl), 3vw, var(--text-4xl));
    font-weight: var(--font-semibold);
    line-height: var(--leading-tight);
    color: var(--rt-primary-color);
    margin: 0 0 var(--space-5) 0;
    letter-spacing: var(--tracking-tight);
    transition: var(--transition-colors);
  }

  .richtext-editor :global(h3) {
    font-family: var(--rt-heading-font);
    font-size: clamp(var(--text-2xl), 2.5vw, var(--text-3xl));
    font-weight: var(--font-medium);
    line-height: var(--leading-normal);
    color: var(--rt-primary-color);
    margin: 0 0 var(--space-4) 0;
    transition: var(--transition-colors);
  }

  .richtext-editor :global(h4) {
    font-family: var(--rt-heading-font);
    font-size: clamp(var(--text-xl), 2vw, var(--text-2xl));
    font-weight: var(--font-medium);
    line-height: var(--leading-normal);
    color: var(--rt-primary-color);
    margin: 0 0 var(--space-3) 0;
    transition: var(--transition-colors);
  }

  .richtext-editor :global(h5) {
    font-family: var(--rt-heading-font);
    font-size: clamp(var(--text-lg), 1.75vw, var(--text-xl));
    font-weight: var(--font-medium);
    line-height: var(--leading-normal);
    color: var(--rt-primary-color);
    margin: 0 0 var(--space-3) 0;
    transition: var(--transition-colors);
  }

  .richtext-editor :global(h6) {
    font-family: var(--rt-heading-font);
    font-size: clamp(var(--text-base), 1.5vw, var(--text-lg));
    font-weight: var(--font-medium);
    line-height: var(--leading-normal);
    color: var(--rt-secondary-color);
    margin: 0 0 var(--space-3) 0;
    transition: var(--transition-colors);
  }

  /* Párrafos HTML estándar */
  .richtext-editor :global(p) {
    font-family: var(--rt-font-family);
    font-size: clamp(var(--text-base), 1.25vw, var(--text-lg));
    font-weight: var(--font-normal);
    line-height: var(--leading-normal);
    color: var(--rt-primary-color);
    margin: 0 0 var(--space-4) 0;
    transition: var(--transition-colors);
  }

  /* Elementos inline HTML estándar */
  .richtext-editor :global(strong) {
    font-weight: var(--font-bold);
    color: inherit; /* Permite que el color se pueda sobrescribir con estilos inline */
    transition: var(--transition-colors);
  }

  .richtext-editor :global(em) {
    font-style: italic;
    color: inherit;
    transition: var(--transition-colors);
  }

  .richtext-editor :global(u) {
    text-decoration: underline;
    text-decoration-color: var(--rt-accent-color);
    text-underline-offset: var(--space-1);
    transition: var(--transition-colors);
  }

  .richtext-editor :global(code) {
    font-family: var(--rt-mono-font);
    font-size: 0.9em;
    background-color: var(--rt-border-color);
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
    color: var(--rt-primary-color);
    transition: var(--transition-base);
  }

  /* Enlaces HTML estándar */
  .richtext-editor :global(a) {
    color: var(--rt-accent-color);
    text-decoration: none;
    font-weight: var(--font-medium);
    border-bottom: var(--border-1) solid transparent;
    transition: var(--transition-colors);
  }

  .richtext-editor :global(a:hover) {
    border-bottom-color: var(--rt-accent-color);
  }

  /* Listas HTML estándar */
  .richtext-editor :global(ul),
  .richtext-editor :global(ol) {
    margin: var(--space-4) 0;
    padding-left: var(--space-6);
  }

  .richtext-editor :global(li) {
    font-family: var(--rt-font-family);
    font-size: clamp(var(--text-base), 1.25vw, var(--text-lg));
    line-height: var(--leading-normal);
    color: var(--rt-primary-color);
    margin-bottom: var(--space-2);
    transition: var(--transition-colors);
  }

  /* Blockquotes HTML estándar */
  .richtext-editor :global(blockquote) {
    font-family: var(--rt-heading-font);
    font-size: clamp(var(--text-lg), 1.5vw, var(--text-xl));
    font-style: italic;
    line-height: var(--leading-normal);
    color: var(--rt-secondary-color);
    margin: var(--space-8) 0;
    padding: var(--space-6) var(--space-8);
    border-left: var(--border-4) solid var(--rt-accent-color);
    background-color: var(--rt-border-color);
    position: relative;
    transition: var(--transition-base);
  }

  .richtext-editor :global(blockquote::before) {
    content: '"';
    font-family: var(--rt-heading-font);
    font-size: var(--text-5xl);
    color: var(--rt-accent-color);
    position: absolute;
    left: var(--space-2);
    top: 0;
    line-height: 1;
    opacity: 0.3;
    transition: var(--transition-colors);
  }

  /* Responsive para elementos HTML estándar */
  @media (max-width: 768px) {
    .richtext-editor :global(blockquote) {
      padding: var(--space-4) var(--space-6);
      margin: var(--space-6) 0;
    }

    .richtext-editor :global(blockquote::before) {
      font-size: var(--text-4xl);
      left: var(--space-1);
    }
  }
</style>