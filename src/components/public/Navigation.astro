---
// Navigation.astro - Migrado al Design System
export const prerender = true;

import lightLogo from '../../assets/mini-logo-light.svg'; // Logo para tema oscuro
import darkLogo from '../../assets/mini-logo-dark.svg';      // Logo para tema claro
import Text from '../i18n/Text.astro';
import LanguagePicker from '../i18n/LanguagePicker.astro';
---

<nav>
    <!-- Hamburger button (solo visible en móvil) -->
    <button class="hamburger" id="hamburger" aria-label="Menu">
        <span></span>
        <span></span>
        <span></span>
    </button>
    
    <!-- Nav items (desktop) con logo integrado -->
    <ul class="nav-desktop">
        <li><a data-scroll-to="inicio"><Text key="nav.home"/></a></li>
        <li><a data-scroll-to="historia"><Text key="nav.story"></a></li>
        <li class="logo-item">
            <a href="#hero" aria-label="Ir a inicio - El Palleter">
                <!-- Logo para tema oscuro -->
                <img 
                    src={lightLogo.src} 
                    alt="El Palleter Logo"
                    class="logo-dark logo-transition"
                    data-logo="dark"
                />
                <!-- Logo para tema claro -->
                <img 
                    src={darkLogo.src} 
                    alt="El Palleter Logo"
                    class="logo-light logo-transition"
                    data-logo="light"
                />
            </a>
        </li>
        <li><a data-scroll-to="carta"><Text key="nav.menu"/></a></li>
        <li><a data-scroll-to="contacto"><Text key="nav.contact"/></a></li>
        <!-- Language Picker para Desktop -->
        <li class="language-item">
            <LanguagePicker variant="desktop" includeThemeToggle={true} />
        </li>
    </ul>
    
    <!-- Logo solo para móvil -->
    <div class="logo-mobile">
        <a href="#hero" aria-label="Ir a inicio - El Palleter">
            <!-- Logo para tema oscuro -->
            <img 
                src={lightLogo.src} 
                alt="El Palleter Logo"
                class="logo-dark logo-transition"
                data-logo="dark"
            />
            <!-- Logo para tema claro -->
            <img 
                src={darkLogo.src} 
                alt="El Palleter Logo"
                class="logo-light logo-transition"
                data-logo="light"
            />
        </a>
    </div>
    
    <!-- Language Picker para Mobile -->
    <div class="language-mobile">
        <LanguagePicker variant="mobile" includeThemeToggle={true} />
    </div>
</nav>

<style>
    /* === NAV PRINCIPAL - USANDO DESIGN SYSTEM === */
    nav {
        max-width: 1200px;
        width: 100%;
        font-family: var(--font-primary);
        position: relative;
        display: flex;
        align-items: center;
        z-index: var(--z-20);
        contain: layout style;
    }
    
    /* === HAMBURGER BUTTON - USANDO TOKENS === */
    .hamburger {
        display: none;
        flex-direction: column;
        background: none;
        border: none;
        cursor: pointer;
        padding: var(--space-3);
        position: absolute;
        left: var(--space-4);
        z-index: 103;
        transition: var(--transition-fast);
    }

    .hamburger:focus-visible {
        outline: var(--border-2) solid var(--focus-ring);
        outline-offset: var(--space-1);
        border-radius: var(--radius-sm);
    }
    
    .hamburger span {
        width: 25px;
        height: var(--space-1);
        background: var(--text-primary);
        margin: var(--space-1) 0;
        border-radius: var(--radius-sm);
        filter: drop-shadow(0 var(--space-1) var(--space-2) var(--text-shadow-color));
        transition: var(--transition-fast);
    }

    .hamburger:hover span {
        background: var(--accent-primary);
    }
    
    /* === LOGO MÓVIL - USANDO TOKENS === */
    .logo-mobile {
        display: none;
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        z-index: 102;
        width: 120px;
        height: 90px;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        color: transparent;
        font-size: 0;
    }
    
    /* === NAVEGACIÓN DESKTOP - MIGRADA === */
    .nav-desktop {
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        list-style: none;
        padding: 0;
        margin: 0;
        width: 100%;
        gap: var(--space-20);
    }

    .nav-desktop li {
        margin: 0;
        padding: 0;
        list-style: none;
    }
    
    /* === ENLACES DE NAVEGACIÓN - USANDO SYSTEM === */
    .nav-desktop li:not(.logo-item):not(.language-item) a {
        text-decoration: none;
        font-size: var(--text-base);
        font-weight: var(--font-semibold);
        padding: var(--space-3);
        color: var(--text-primary);
        letter-spacing: var(--tracking-normal);
        border-radius: var(--radius-lg);
        transition: var(--transition-base);
        display: block;
        text-align: center;
        white-space: nowrap;
        position: relative;
        cursor: pointer;
        text-transform: uppercase;
        
        /* Text shadow adaptativo del sistema */
        text-shadow: 0 var(--space-1) var(--space-1) var(--text-shadow-color);
    }
    
    .nav-desktop li:not(.logo-item):not(.language-item) a:hover {
        background: var(--hover-overlay);
        transform: translateY(calc(-1 * var(--space-1)));
        text-shadow: 0 var(--space-2) var(--space-4) var(--text-shadow-hover-color);
    }

    .nav-desktop li:not(.logo-item):not(.language-item) a:focus-visible {
        outline: var(--border-2) solid var(--focus-ring);
        outline-offset: var(--space-1);
    }
    
    /* === INDICADOR DE SECCIÓN ACTIVA === */
    .nav-desktop li:not(.logo-item):not(.language-item) a.active {
        background: var(--accent-light);
        color: var(--accent-primary);
    }
    
    /* === LOGO ITEM - SIMPLIFICADO === */
    .logo-item {
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 var(--space-2);
        min-width: 120px;
        width: 120px;
    }
    
    .logo-item a {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        border-radius: 0;
        transition: var(--transition-base);
        width: 120px;
        height: 90px;
        overflow: hidden;
        color: transparent;
        font-size: 0;
        position: relative;
    }

    .logo-item a:focus-visible {
        outline: var(--border-2) solid var(--focus-ring);
        outline-offset: var(--space-2);
        border-radius: var(--radius-lg);
    }
    
    /* === LOGOS - SISTEMA DE CAMBIO DINÁMICO DEL DESIGN SYSTEM === */
    .logo-item img,
    .logo-mobile img {
        height: 85px;
        width: auto;
        max-width: 120px;
        object-fit: contain;
        display: block;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        opacity: 0;
        /* Usando la clase del sistema */
    }

    /* Por defecto mostrar logo oscuro (tema dark) */
    .logo-dark {
        opacity: 1;
    }

    .logo-light {
        opacity: 0;
    }

    /* En tema claro, mostrar logo claro */
    :root[data-theme="light"] .logo-dark,
    html[data-theme="light"] .logo-dark {
        opacity: 0;
    }

    :root[data-theme="light"] .logo-light,
    html[data-theme="light"] .logo-light {
        opacity: 1;
    }

    /* Hover effect usando tokens */
    .logo-item a:hover img,
    .logo-mobile a:hover img {
        transform: translate(-50%, -50%) scale(1.03);
    }
    
    /* === LANGUAGE ITEM === */
    .language-item {
        position: absolute;
        right: 0;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    /* === RESPONSIVE USANDO BREAKPOINTS DEL SISTEMA === */
    @media (max-width: 1399px) {
        .nav-desktop li:not(.logo-item):not(.language-item) a {
            font-size: var(--text-sm);
            padding: var(--space-2) var(--space-3);
            letter-spacing: var(--tracking-tight);
        }
        
        .nav-desktop {
            gap: var(--space-20);
        }
    }
    
    @media (max-width: 1023px) {
        .nav-desktop li:not(.logo-item):not(.language-item) a {
            font-size: var(--text-sm);
            padding: var(--space-2);
            letter-spacing: var(--tracking-tight);
        }
        
        .nav-desktop {
            gap: var(--space-10);
        }
        
        .logo-item {
            margin: 0 var(--space-1);
        }
    }
    
    /* === MOBILE BREAKPOINT === */
    @media (max-width: 767px) {
        .hamburger {
            display: flex;
        }
        
        .nav-desktop {
            display: none;
        }
        
        .logo-mobile {
            display: flex;
        }
        
        .language-mobile {
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            right: var(--space-2);
        }
        
        nav {
            padding: 0 var(--space-4);
        }
    }
    
    @media (max-width: 420px) {
        .logo-mobile img {
            height: 80px;
        }
        
        .hamburger {
            left: var(--space-2);
        }
    }

    /* === ACCESIBILIDAD === */
    @media (prefers-reduced-motion: reduce) {
        .hamburger,
        .hamburger span,
        .logo-mobile img,
        .logo-item img,
        .nav-desktop li a,
        .logo-transition {
            transition: none;
        }
        
        .nav-desktop li:not(.logo-item):not(.language-item) a:hover,
        .logo-item a:hover img,
        .logo-mobile a:hover img {
            transform: none;
        }
        
        .logo-item a:hover img,
        .logo-mobile a:hover img {
            transform: translate(-50%, -50%);
        }
    }
    
    @media (prefers-contrast: high) {
        .hamburger span {
            background: var(--text-primary);
            height: var(--space-1);
        }
        
        .nav-desktop li:not(.logo-item):not(.language-item) a {
            border: var(--border-1) solid transparent;
        }
        
        .nav-desktop li:not(.logo-item):not(.language-item) a:hover {
            border-color: var(--accent-primary);
            background: var(--accent-light);
        }
    }

    /* === MEJORAS DE RENDIMIENTO === */
    .logo-item img,
    .logo-mobile img {
        will-change: transform, opacity;
        backface-visibility: hidden;
    }
    
    .nav-desktop li:not(.logo-item):not(.language-item) a {
        will-change: background-color, transform;
    }

    /* === ESTADOS ADICIONALES === */
    nav.loading {
        pointer-events: none;
        opacity: 0.7;
    }
    
    nav.nav-active .hamburger span {
        background: var(--accent-primary);
    }
</style>

<script>
    import ThemeService from '../../services/ThemeService.js';

    // Función para actualizar los logos según el tema
    function updateLogosForTheme(theme) {
        const logosDark = document.querySelectorAll('[data-logo="dark"]');
        const logosLight = document.querySelectorAll('[data-logo="light"]');
        
        if (theme === 'light') {
            logosDark.forEach(logo => logo.style.opacity = '0');
            logosLight.forEach(logo => logo.style.opacity = '1');
        } else {
            logosDark.forEach(logo => logo.style.opacity = '1');
            logosLight.forEach(logo => logo.style.opacity = '0');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Inicializar ThemeService si no está inicializado
        if (!ThemeService.currentTheme) {
            ThemeService.initialize();
        }

        // Actualizar logos al cargar
        updateLogosForTheme(ThemeService.getCurrentTheme());

        // Suscribirse a cambios de tema
        ThemeService.onThemeChange((event) => {
            updateLogosForTheme(event.theme);
        });
    });

    // Para navegación SPA en Astro
    document.addEventListener('astro:page-load', () => {
        if (ThemeService.currentTheme) {
            updateLogosForTheme(ThemeService.getCurrentTheme());
        }
    });
</script>