---
export const prerender = true;

import ImageSlider from './ImageSlider.astro';
import Text from '../i18n/Text.astro';
import RichText from '../i18n/RichText.astro';
import { ImageService } from '../../services/ImageService.js';

const imagesToShow = ImageService.getGalleryImages('historia');
---

<section class="historia-section" id="historia">
    <div class="historia-header">
        <h2 class="historia-title">
            <Text key="story.title" fallback="Historia" />
        </h2>
        <p class="historia-subtitle">
            <Text key="story.subtitle" fallback="Desde 1985 en el corazón de Benissa con mucho orgullo" />
        </p>
    </div>
    <div class="historia-container container">
        <!-- Historia a la izquierda -->
        <div class="history-content">
            <RichText 
                key="historia_content" 
                fallback={'Historia no disponible'}
                className="historia-rich-content"
                theme="adaptive"
            />
        </div>
    
        <!-- Slider de fotos a la derecha -->
        <div class="slider-section">
            <ImageSlider 
                images={imagesToShow}
            />
        </div>
    </div>
</section>

<style>
    /* =====================================================
       HISTORIA SECTION - ACTUALIZADO CON DESIGN TOKENS
       Mantiene exactamente el mismo diseño visual
       ===================================================== */

    /* === SECCIÓN BASE === */
    .historia-section {
        width: 100%;
        height: fit-content;
        display: flex;
        align-items: stretch;
        position: relative;
        overflow: hidden;
        box-sizing: border-box;
        flex-direction: column;
    }

    .historia-header {
        text-align: center;
        margin-bottom: calc(var(--gap-mobile) * 3);
    }

    .historia-title {
        font-size: clamp(var(--text-3xl), 4vw, var(--text-5xl));
        font-weight: var(--font-light);
        color: var(--accent-primary);
        margin-bottom: var(--gap-mobile);
        letter-spacing: var(--tracking-wide);
        transition: color var(--duration-300) var(--ease-out);
    }

    .historia-subtitle {
        font-size: var(--text-lg);
        color: var(--text-secondary);
        opacity: 0.8;
        transition: color var(--duration-300) var(--ease-out);
    }

    /* === CONTAINER USANDO SISTEMA GLOBAL === */
    .historia-container {
        min-height: 660px; /* Mínimo para el slider */
        height: auto; /* Permite crecer con el contenido */
        display: flex;
        flex-direction: row;
        gap: var(--gap-mobile);
        position: relative;
        z-index: 2;
        overflow: hidden;
    }

    /* === CONTENT SECTIONS - TEMA OSCURO (original) === */
    .history-content {
        flex: 1.2;
        padding: var(--padding-mobile);
        display: flex;
        flex-direction: column;
        justify-content: center;
        
        /* Diseño original para tema oscuro */
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: var(--backdrop-blur);
        -webkit-backdrop-filter: var(--backdrop-blur);
        border-radius: var(--radius-2xl);
        border: var(--border-1) solid rgba(244, 162, 97, 0.2);
        box-shadow: 0 var(--space-2) var(--space-8) rgba(0, 0, 0, 0.3); /* Sombra uniforme */
        overflow: hidden;
        min-height: 0;
        
        /* Transiciones suaves */
        transition: background-color var(--duration-300) var(--ease-out),
                    border-color var(--duration-300) var(--ease-out),
                    box-shadow var(--duration-300) var(--ease-out);
    }

    .slider-section {
        flex: 1.3;
        min-height: 660px; /* Altura mínima específica para desktop */
        height: auto; /* Permite crecer si es necesario */
        display: grid;
        place-items: center;
        
        /* Diseño original para tema oscuro */
        background: rgba(0, 0, 0, 0.4);
        border-radius: var(--radius-2xl);
        border: var(--border-1) solid rgba(244, 162, 97, 0.15);
        box-shadow: 0 var(--space-2) var(--space-6) rgba(0, 0, 0, 0.2); /* Sombra uniforme */
        overflow: hidden;
        backface-visibility: hidden;
        isolation: isolate;
        contain: layout style;
        
        /* Transiciones suaves */
        transition: background-color var(--duration-300) var(--ease-out),
                    border-color var(--duration-300) var(--ease-out),
                    box-shadow var(--duration-300) var(--ease-out);
    }

    /* === TEMA CLARO - CONTAINERS QUE RESALTAN === */
    :root[data-theme="light"] .history-content,
    html[data-theme="light"] .history-content {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(20px) saturate(150%);
        border: var(--border-1) solid var(--gray-400);
        box-shadow: 0 var(--space-2) var(--space-8) rgba(0, 0, 0, 0.15); /* Sombra uniforme */
    }

    :root[data-theme="light"] .slider-section,
    html[data-theme="light"] .slider-section {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(15px) saturate(130%);
        border: var(--border-1) solid var(--gray-300);
        box-shadow: 0 var(--space-2) var(--space-6) rgba(0, 0, 0, 0.1); /* Sombra uniforme */
    }

    /* === RICH TEXT STYLING === */
    .history-content :global(.historia-rich-content) {
        width: 100%;
        max-width: 100%;
        overflow-wrap: break-word;
        word-wrap: break-word;
        hyphens: auto;
    }

    .history-content :global(.historia-rich-content p),
    .history-content :global(.historia-rich-content div),
    .history-content :global(.historia-rich-content span) {
        max-width: 100%;
        overflow-wrap: break-word;
    }

    /* === RESPONSIVE - USANDO TOKENS === */
    
    /* TABLET Y SUPERIOR (768px+) */
    @media (min-width: 768px) {
        .historia-header {
            margin-bottom: calc(var(--gap-tablet) * 2);
        }

        .historia-title {
            font-size: clamp(var(--text-4xl), 4vw, var(--text-5xl));
            margin-bottom: var(--gap-tablet);
        }

        .historia-subtitle {
            font-size: var(--text-xl);
        }

        .historia-container {
            gap: var(--gap-tablet);
        }
        
        .history-content {
            padding: var(--padding-tablet);
        }
        
        .slider-section {
            height: auto; /* Permite crecer */
            min-height: 500px; /* Altura mínima para tablet */
        }
    }

    /* DESKTOP (1024px+) */
    @media (min-width: 1024px) {
        .historia-header {
            margin-bottom: calc(var(--gap-desktop) * 1.33);
        }

        .historia-title {
            margin-bottom: var(--gap-desktop);
        }

        .historia-container {
            gap: var(--gap-desktop);
        }
        
        .history-content {
            padding: var(--padding-desktop);
        }
    }

    /* DESKTOP LARGE (1400px+) */
    @media (min-width: 1400px) {
        .historia-header {
            margin-bottom: var(--gap-desktop-lg);
        }

        .historia-title {
            margin-bottom: var(--gap-desktop-lg);
        }

        .historia-container {
            gap: var(--gap-desktop-lg);
        }
    }

    /* MOBILE (0-767px) */
    @media (max-width: 767px) {
        .historia-section {
            min-height: auto;
            max-height: none;
            display: block;
            align-items: unset;
        }
        
        .historia-header {
            margin-bottom: calc(var(--gap-mobile) * 2);
        }

        .historia-title {
            font-size: clamp(var(--text-2xl), 4vw, var(--text-4xl));
            margin-bottom: calc(var(--gap-mobile) * 0.75);
        }

        .historia-subtitle {
            font-size: var(--text-base);
        }
        
        .historia-container {
            flex-direction: column;
            height: auto;
            gap: calc(var(--gap-mobile) * 1.5);
        }
        
        .history-content {
            order: 2;
            padding: var(--padding-mobile);
            height: auto;
        }
        
        .slider-section {
            order: 1;
            min-height: 40vh; /* Altura mínima responsiva en móvil */
            height: auto; /* Permite crecer si es necesario */
            
            /* Diseño móvil original para tema oscuro */
            background: rgba(0, 0, 0, 0.3);
            border-radius: var(--radius-xl);
            border: var(--border-1) solid rgba(244, 162, 97, 0.2);
            box-shadow: 0 var(--space-3) var(--space-6) rgba(0, 0, 0, 0.2);
            transform: translate3d(0, 0, 0);
        }

        /* Tema claro en móvil */
        :root[data-theme="light"] .slider-section,
        html[data-theme="light"] .slider-section {
            background: rgba(255, 255, 255, 0.85);
            border: var(--border-1) solid var(--gray-300);
            box-shadow: 0 var(--space-3) var(--space-6) rgba(0, 0, 0, 0.1);
        }
    }

    /* MOBILE PEQUEÑO (0-420px) */
    @media (max-width: 420px) {
        .historia-header {
            margin-bottom: calc(var(--gap-mobile) * 1.5);
        }

        .historia-title {
            font-size: clamp(var(--text-xl), 4vw, var(--text-3xl));
            margin-bottom: calc(var(--gap-mobile) * 0.5);
        }

        .historia-subtitle {
            font-size: var(--text-sm);
        }

        .historia-container {
            gap: calc(var(--gap-mobile) * 1.5);
        }
        
        .slider-section {
            min-height: 35vh; /* Altura mínima responsiva en móvil pequeño */
            height: auto; /* Permite crecer */
        }
        
        .history-content {
            border-radius: var(--radius-xl);
        }
    }

    /* === ESTADOS DE CARGA === */
    
    .historia-section.loading .history-content,
    .historia-section.loading .slider-section {
        opacity: 0.7;
    }

    .historia-section.loaded .history-content,
    .historia-section.loaded .slider-section {
        opacity: 1;
        transition: opacity var(--duration-300) var(--ease-out);
    }

    /* === ACCESIBILIDAD === */
    
    /* Alto contraste */
    @media (prefers-contrast: high) {
        .history-content {
            border: var(--border-2) solid rgba(244, 162, 97, 0.5);
            background: rgba(0, 0, 0, 0.8);
        }
        
        .slider-section {
            border: var(--border-2) solid rgba(244, 162, 97, 0.3);
            background: rgba(0, 0, 0, 0.6);
        }

        :root[data-theme="light"] .history-content,
        html[data-theme="light"] .history-content {
            border: var(--border-2) solid var(--gray-600);
            background: rgba(255, 255, 255, 0.95);
        }
        
        :root[data-theme="light"] .slider-section,
        html[data-theme="light"] .slider-section {
            border: var(--border-2) solid var(--gray-500);
            background: rgba(255, 255, 255, 0.9);
        }
    }

    /* === PREFERENCIAS DE USUARIO === */
    
    /* Respeto por movimiento reducido */
    @media (prefers-reduced-motion: reduce) {
        .history-content,
        .slider-section,
        .historia-title,
        .historia-subtitle {
            transition: none;
        }
    }

    /* === OPTIMIZACIONES DE PERFORMANCE === */
    
    /* Contener layout para mejor performance */
    .historia-container {
        contain: layout style;
    }
</style>

<script>
    import { useBreakpoints, disableTransitionsDuringResize } from '../../utils/breakpoints.js';
    
    document.addEventListener('DOMContentLoaded', () => {
        const historyContent = document.querySelector('.history-content');
        const sliderSection = document.querySelector('.slider-section');
        const historiaSection = document.querySelector('.historia-section');
        
        // Inicializar sistema de breakpoints
        const breakpoints = useBreakpoints('historia-component', {
            element: historiaSection
        });
        
        // Simplificado: Solo cargar sin animaciones
        const initializeWhenReady = () => {
            setTimeout(() => {
                if (historiaSection) {
                    historiaSection.classList.add('loaded');
                }
            }, 150);
        };
        
        // Suscribirse a cambios de breakpoint
        breakpoints.subscribe({
            onBreakpointChange: (newBreakpoint, oldBreakpoint) => {
                console.log(`Historia: Breakpoint changed ${oldBreakpoint} → ${newBreakpoint}`);
                
                const elementsToAdjust = [historyContent, sliderSection].filter(Boolean);
                disableTransitionsDuringResize(elementsToAdjust);
            }
        });
        
        initializeWhenReady();
        
        // Cleanup del breakpoint manager
        window.addEventListener('beforeunload', () => {
            breakpoints.unsubscribe();
        });
    });
</script>