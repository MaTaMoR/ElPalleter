---
export const prerender = true;

import ImageSlider from './ImageSlider.astro';
import Text from '../i18n/Text.astro';
import RichText from '../i18n/RichText.astro';
import { ImageService } from '../../services/ImageService.js';

const imagesToShow = ImageService.getGalleryImages('historia');
---

<section class="historia-section" id="historia">
    <div class="historia-header">
        <h2 class="historia-title">
            <Text key="story.title" fallback="Historia" />
        </h2>
        <p class="historia-subtitle">
            <Text key="story.subtitle" fallback="Desde 1985 en el corazón de Benissa con mucho orgullo" />
        </p>
    </div>
    <div class="historia-container container">
        <!-- Historia a la izquierda -->
        <div class="history-content">
            <RichText 
                key="historia_content" 
                fallback={'Historia no disponible'}
                className="historia-rich-content"
                theme="gold"
            />
        </div>
    
        <!-- Slider de fotos a la derecha -->
        <div class="slider-section">
            <ImageSlider 
                images={imagesToShow}
            />
        </div>
    </div>
</section>

<style>
    /* =====================================================
       HISTORIA SECTION - ACTUALIZADO CON DESIGN TOKENS
       Mantiene exactamente el mismo diseño visual
       ===================================================== */

    /* === SECCIÓN BASE === */
    .historia-section {
        width: 100%;
        height: fit-content;
        display: flex;
        align-items: stretch;
        position: relative;
        overflow: hidden;
        box-sizing: border-box;
        flex-direction: column;
    }

    .historia-header {
        text-align: center;
        margin-bottom: calc(var(--gap-mobile) * 3);
    }

    .historia-title {
        font-size: clamp(var(--text-3xl), 4vw, var(--text-5xl)); /* Tokens en lugar de clamp(2rem, 4vw, 3.5rem) */
        font-weight: var(--font-light);                          /* Token en lugar de 300 */
        color: var(--accent-primary);                            /* Token dinámico en lugar de #f4a261 */
        margin-bottom: var(--gap-mobile);
        letter-spacing: var(--tracking-wide);                    /* Token en lugar de 2px */
    }

    .historia-subtitle {
        font-size: var(--text-lg);                              /* Token en lugar de 1.1rem */
        color: var(--text-secondary);                           /* Token dinámico en lugar de #ccc */
        opacity: 0.8;
    }

    /* === CONTAINER USANDO SISTEMA GLOBAL === */
    .historia-container {
        height: 660px;
        display: flex;
        flex-direction: row;
        gap: var(--gap-mobile);
        position: relative;
        z-index: 2;
        overflow: hidden;
    }

    /* === CONTENT SECTIONS - MANTENIENDO DISEÑO ORIGINAL === */
    .history-content {
        flex: 1.2;
        padding: var(--padding-mobile);
        display: flex;
        flex-direction: column;
        justify-content: center;
        
        /* ✨ MANTENER: Exactamente el mismo diseño visual */
        background: rgba(0, 0, 0, 0.6);                         /* Mantener opacidad original */
        backdrop-filter: var(--backdrop-blur);                  /* Token en lugar de blur(15px) */
        -webkit-backdrop-filter: var(--backdrop-blur);
        border-radius: var(--radius-2xl);                       /* Token en lugar de 20px */
        border: var(--border-1) solid rgba(244, 162, 97, 0.2);  /* Mantener color original */
        box-shadow: 0 var(--space-5) var(--space-10) rgba(0, 0, 0, 0.3); /* Tokens en lugar de 20px 40px */
        overflow: hidden;
        height: 100%;
        
        min-height: 0;
        max-height: 100%;
    }

    .slider-section {
        flex: 1.3;
        height: 100%;
        display: grid;
        place-items: center;
        
        /* ✨ MANTENER: Exactamente el mismo diseño visual */
        background: rgba(0, 0, 0, 0.4);                         /* Mantener opacidad original */
        border-radius: var(--radius-2xl);                       /* Token en lugar de 20px */
        border: var(--border-1) solid rgba(244, 162, 97, 0.15); /* Mantener color original */
        box-shadow: 0 var(--space-4) var(--space-8) rgba(0, 0, 0, 0.2); /* Tokens en lugar de 15px 35px */
        overflow: hidden;
        backface-visibility: hidden;
        isolation: isolate;
        contain: layout style;
        
        min-height: 0;
        max-height: 100%;
    }

    /* === RICH TEXT STYLING === */
    .history-content :global(.historia-rich-content) {
        width: 100%;
        max-width: 100%;
        overflow-wrap: break-word;
        word-wrap: break-word;
        hyphens: auto;
    }

    .history-content :global(.historia-rich-content p),
    .history-content :global(.historia-rich-content div),
    .history-content :global(.historia-rich-content span) {
        max-width: 100%;
        overflow-wrap: break-word;
    }

    /* === RESPONSIVE - USANDO TOKENS === */
    
    /* TABLET Y SUPERIOR (768px+) */
    @media (min-width: 768px) {
        .historia-header {
            margin-bottom: calc(var(--gap-tablet) * 2);
        }

        .historia-title {
            font-size: clamp(var(--text-4xl), 4vw, var(--text-5xl));
            margin-bottom: var(--gap-tablet);
        }

        .historia-subtitle {
            font-size: var(--text-xl);                          /* Token en lugar de 1.2rem */
        }

        .historia-container {
            gap: var(--gap-tablet);
        }
        
        .history-content {
            padding: var(--padding-tablet);
        }
        
        .slider-section {
            height: 100%;
            min-height: auto;
        }
    }

    /* DESKTOP (1024px+) */
    @media (min-width: 1024px) {
        .historia-header {
            margin-bottom: calc(var(--gap-desktop) * 1.33);
        }

        .historia-title {
            margin-bottom: var(--gap-desktop);
        }

        .historia-container {
            gap: var(--gap-desktop);
        }
        
        .history-content {
            padding: var(--padding-desktop);
        }
    }

    /* DESKTOP LARGE (1400px+) */
    @media (min-width: 1400px) {
        .historia-header {
            margin-bottom: var(--gap-desktop-lg);
        }

        .historia-title {
            margin-bottom: var(--gap-desktop-lg);
        }

        .historia-container {
            gap: var(--gap-desktop-lg);
        }
    }

    /* MOBILE (0-767px) */
    @media (max-width: 767px) {
        .historia-section {
            min-height: auto;
            max-height: none;
            display: block;
            align-items: unset;
        }
        
        .historia-header {
            margin-bottom: calc(var(--gap-mobile) * 2);
        }

        .historia-title {
            font-size: clamp(var(--text-2xl), 4vw, var(--text-4xl));
            margin-bottom: calc(var(--gap-mobile) * 0.75);
        }

        .historia-subtitle {
            font-size: var(--text-base);                        /* Token en lugar de 1rem */
        }
        
        .historia-container {
            flex-direction: column;
            height: auto;
            gap: calc(var(--gap-mobile) * 1.5);
        }
        
        .history-content {
            order: 2;
            padding: var(--padding-mobile);
            height: auto;
        }
        
        .slider-section {
            order: 1;
            min-height: 40vh;
            height: 40vh;
            
            /* ✨ MANTENER: Diseño móvil original */
            background: rgba(0, 0, 0, 0.3);                     /* Mantener opacidad original */
            border-radius: var(--radius-xl);                    /* Token en lugar de 15px */
            border: var(--border-1) solid rgba(244, 162, 97, 0.2); /* Mantener color original */
            box-shadow: 0 var(--space-3) var(--space-6) rgba(0, 0, 0, 0.2); /* Tokens en lugar de 10px 25px */
            transform: translate3d(0, 0, 0);
        }
    }

    /* MOBILE PEQUEÑO (0-420px) */
    @media (max-width: 420px) {
        .historia-header {
            margin-bottom: calc(var(--gap-mobile) * 1.5);
        }

        .historia-title {
            font-size: clamp(var(--text-xl), 4vw, var(--text-3xl));
            margin-bottom: calc(var(--gap-mobile) * 0.5);
        }

        .historia-subtitle {
            font-size: var(--text-sm);
        }

        .historia-container {
            gap: calc(var(--gap-mobile) * 1.5);
        }
        
        .slider-section {
            min-height: 35vh;
            height: 35vh;
        }
        
        .history-content {
            border-radius: var(--radius-xl);                     /* Token en lugar de 15px */
        }
    }

    /* === ANIMACIONES REMOVIDAS === */
    /* ✨ REMOVIDO: Animaciones de entrada para mantener diseño original */

    /* === ESTADOS DE CARGA === */
    
    .historia-section.loading .history-content,
    .historia-section.loading .slider-section {
        opacity: 0.7;
    }

    .historia-section.loaded .history-content,
    .historia-section.loaded .slider-section {
        opacity: 1;
        transition: opacity var(--duration-300) var(--ease-out);
    }

    /* === ACCESIBILIDAD === */
    
    /* ✨ REMOVIDO: Focus outline para mantener diseño original */

    /* === PREFERENCIAS DE USUARIO === */
    
    /* Respeto por movimiento reducido */
    @media (prefers-reduced-motion: reduce) {
        /* Ya no hay animaciones que deshabilitar */
    }
    
    /* Alto contraste */
    @media (prefers-contrast: high) {
        .history-content {
            border: var(--border-2) solid rgba(244, 162, 97, 0.5);
            background: rgba(0, 0, 0, 0.8);
        }
        
        .slider-section {
            border: var(--border-2) solid rgba(244, 162, 97, 0.3);
            background: rgba(0, 0, 0, 0.6);
        }
    }

    /* === OPTIMIZACIONES DE PERFORMANCE === */
    
    /* Contener layout para mejor performance */
    .historia-container {
        contain: layout style;
    }
</style>

<script>
    import { useBreakpoints, disableTransitionsDuringResize } from '../../utils/breakpoints.js';
    
    document.addEventListener('DOMContentLoaded', () => {
        const historyContent = document.querySelector('.history-content');
        const sliderSection = document.querySelector('.slider-section');
        const historiaSection = document.querySelector('.historia-section');
        
        // Inicializar sistema de breakpoints
        const breakpoints = useBreakpoints('historia-component', {
            element: historiaSection
        });
        
        // ✨ SIMPLIFICADO: Solo cargar sin animaciones
        const initializeWhenReady = () => {
            setTimeout(() => {
                if (historiaSection) {
                    historiaSection.classList.add('loaded');
                }
            }, 150);
        };
        
        // Suscribirse a cambios de breakpoint
        breakpoints.subscribe({
            onBreakpointChange: (newBreakpoint, oldBreakpoint) => {
                console.log(`Historia: Breakpoint changed ${oldBreakpoint} → ${newBreakpoint}`);
                
                const elementsToAdjust = [historyContent, sliderSection].filter(Boolean);
                disableTransitionsDuringResize(elementsToAdjust);
            }
        });
        
        initializeWhenReady();
        
        // Cleanup del breakpoint manager
        window.addEventListener('beforeunload', () => {
            breakpoints.unsubscribe();
        });
    });
</script>