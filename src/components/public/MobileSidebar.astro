---
export const prerender = true;

import lightLogo from '../../assets/mini-logo-light.svg'; // Logo para tema oscuro
import darkLogo from '../../assets/mini-logo-dark.svg';      // Logo para tema claro
import Text from '../i18n/Text.astro';
---

<!-- Fullscreen Overlay Menu -->
<div class="fullscreen-menu" id="fullscreenMenu">
    <div class="fullscreen-content">
        <!-- Botón de cerrar en la esquina superior derecha -->
        <button class="close-btn" id="closeMenu" aria-label="Cerrar menú">
            <span>✕</span>
        </button>
        
        <!-- Container izquierdo para logo y nav -->
        <div class="left-content">
            <!-- Logo dual en el overlay -->
            <div class="overlay-logo">
                <a href="#hero" aria-label="Ir a inicio - El Palleter">
                    <div class="logo-container">
                        <!-- Logo para tema oscuro -->
                        <img 
                            src={lightLogo.src} 
                            alt="El Palleter Logo" 
                            class="mini-logo logo-dark"
                            data-logo="dark"
                        />
                        <!-- Logo para tema claro -->
                        <img 
                            src={darkLogo.src} 
                            alt="El Palleter Logo" 
                            class="mini-logo logo-light"
                            data-logo="light"
                        />
                    </div>
                </a>
            </div>
            
            <!-- Navegación del overlay -->
            <nav class="overlay-nav">
                <ul>
                    <li><a href="#hero" data-delay="0" data-nav="inicio"><Text key="nav.home"/></a></li>
                    <li><a href="#historia" data-delay="100" data-nav="historia"><Text key="nav.story"/></a></li>
                    <li><a href="#carta" data-delay="200" data-nav="carta"><Text key="nav.menu"/></a></li>
                    <li><a href="#contacto" data-delay="300" data-nav="contacto"><Text key="nav.contact"/></a></li>
                </ul>
            </nav>
        </div>
    </div>
</div>

<style>
    /* === FULLSCREEN MENU OVERLAY === */
    .fullscreen-menu {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: var(--glass-bg);
        backdrop-filter: var(--backdrop-blur);
        z-index: var(--z-modal);
        opacity: 0;
        visibility: hidden;
        transition: all var(--duration-500) var(--ease-in-out);
    }
    
    .fullscreen-menu.active {
        opacity: 1;
        visibility: visible;
    }
    
    .fullscreen-content {
        position: relative;
        width: 100%;
        height: 100%;
    }
    
    /* === BOTÓN DE CERRAR === */
    .close-btn {
        position: absolute;
        top: var(--space-8);
        right: var(--space-8);
        background: none;
        border: none;
        color: var(--text-primary);
        font-size: var(--text-2xl);
        cursor: pointer;
        padding: var(--space-3);
        border-radius: var(--radius-full);
        transition: all var(--duration-200) var(--ease-out);
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1001;
        opacity: 0;
        transform: translateX(var(--space-5));
    }
    
    .fullscreen-menu.active .close-btn {
        opacity: 1;
        transform: translateX(0);
        transition: all var(--duration-300) var(--ease-out) calc(var(--duration-300));
    }
    
    .close-btn:hover {
        background: var(--hover-overlay);
        box-shadow: 0 0 var(--space-4) var(--accent-primary);
        color: var(--accent-primary);
    }

    /* Hover cuando el menú está activo */
    .fullscreen-menu.active .close-btn:hover {
        transform: rotate(90deg) scale(1.1);
        background: var(--hover-overlay);
        box-shadow: 0 0 var(--space-4) var(--accent-primary);
        color: var(--accent-primary);
    }

    .close-btn:active,
    .fullscreen-menu.active .close-btn:active {
        transform: rotate(90deg) scale(0.95);
        background: var(--active-overlay);
    }

    .close-btn:focus-visible {
        outline: var(--border-2) solid var(--focus-ring);
        outline-offset: var(--space-1);
    }
    
    /* === CONTAINER IZQUIERDO === */
    .left-content {
        position: absolute;
        top: var(--space-5);                             /* 1.25rem → var(--space-5) */
        left: var(--space-12);                           /* 3rem → var(--space-12) */
        display: flex;
        flex-direction: column;
        align-items: flex-start;
    }
    
    /* === LOGO DUAL EN EL OVERLAY === */
    .overlay-logo {
        margin-bottom: var(--space-12);
        opacity: 0;
        transform: translateX(calc(-1 * var(--space-8)));
        transition: all var(--duration-500) var(--ease-out);
        margin-top: var(--space-2);
        overflow: hidden; /* Prevenir overflow del logo */
    }
    
    .fullscreen-menu.active .overlay-logo {
        opacity: 1;
        transform: translateX(0);
        transition-delay: var(--duration-200);           /* 0.2s → token */
    }
    
    .overlay-logo a {
        display: block;
        transition: all var(--duration-100) var(--ease-out); /* ✅ Mucho más rápido: 100ms */
    }

    .overlay-logo a:focus-visible {
        outline: var(--border-2) solid var(--focus-ring);
        outline-offset: var(--space-2);
        border-radius: var(--radius-lg);
    }

    /* === CONTENEDOR DE MINI-LOGOS === */
    .logo-container {
        position: relative;
        height: 100px;
        width: 150px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden; /* Prevenir que el scale cause overflow */
        border-radius: var(--radius-lg); /* Para suavizar cualquier clip */
    }
    
    .mini-logo {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        height: 100px;
        width: auto;
        max-width: 150px;
        object-fit: contain;
        filter: drop-shadow(0 var(--space-4) var(--space-12) rgba(0, 0, 0, 0.3));
        transition: opacity var(--duration-300) var(--ease-out), 
                    transform var(--duration-100) var(--ease-out);
    }

    /* Por defecto mostrar logo light (para tema oscuro) */
    .logo-dark {
        opacity: 1;
    }

    .logo-light {
        opacity: 0;
    }

    /* En tema claro, mostrar logo dark */
    :root[data-theme="light"] .logo-dark,
    html[data-theme="light"] .logo-dark {
        opacity: 0;
    }

    :root[data-theme="light"] .logo-light,
    html[data-theme="light"] .logo-light {
        opacity: 1;
    }

    /* Sombras adaptativas por tema */
    .logo-dark {
        filter: drop-shadow(0 var(--space-4) var(--space-12) rgba(0, 0, 0, 0.3));
    }

    .logo-light {
        filter: drop-shadow(0 var(--space-4) var(--space-12) rgba(255, 255, 255, 0.3));
    }
    
    .overlay-logo a:hover .mini-logo {
        transform: translate(-50%, -50%) scale(1.05);
    }
    
    /* === NAVEGACIÓN DEL OVERLAY === */
    .overlay-nav ul {
        list-style: none;
        padding: 0;
        margin: 0;                                       /* ✅ CRÍTICO: Reset margin global */
        text-align: left;
    }
    
    .overlay-nav li {
        margin: var(--space-6) 0;                        /* 1.5rem 0 → var(--space-6) */
        margin-bottom: 0;                                /* ✅ CRÍTICO: Override global li margin */
        padding: 0;                                      /* ✅ CRÍTICO: Reset padding */
    }

    /* ✅ CRÍTICO: Espaciado manual para li */
    .overlay-nav li:not(:last-child) {
        margin-bottom: var(--space-6);                   /* 1.5rem → var(--space-6) */
    }
    
    .overlay-nav a {
        display: block;
        color: var(--text-primary);                      /* white → dinámico */
        text-decoration: none;
        font-size: var(--text-xl);                       /* 1.8rem → var(--text-xl) (ajustado) */
        font-weight: var(--font-semibold);               /* 600 → var(--font-semibold) */
        letter-spacing: var(--tracking-wide);            /* 1px → var(--tracking-wide) */
        font-family: var(--font-primary);                /* -apple-system... → token */
        transition: all var(--duration-100) var(--ease-out); /* ✅ Mucho más rápido: 100ms */
        padding: var(--space-3) var(--space-6);          /* 0.8rem 1.5rem → tokens */
        border-radius: var(--radius-lg);                 /* 8px → var(--radius-lg) */
        text-transform: uppercase;
        border-left: var(--space-1) solid transparent;   /* 3px → var(--space-1) */
        opacity: 0;
        transform: translateX(50px);
    }

    .overlay-nav a:focus-visible {
        outline: var(--border-2) solid var(--focus-ring);
        outline-offset: var(--space-1);
    }
    
    /* === ANIMACIÓN CUANDO SE ABRE EL MENU === */
    .fullscreen-menu.active .overlay-nav a {
        opacity: 1;
        transform: translateX(0);
        transition: all var(--duration-500) var(--ease-in-out); /* 0.6s cubic-bezier → tokens */
    }
    
    /* Delays escalonados para cada elemento */
    .fullscreen-menu.active .overlay-nav a[data-delay="0"] {
        transition-delay: var(--duration-300);           /* 0.4s → var(--duration-300) + offset */
    }
    
    .fullscreen-menu.active .overlay-nav a[data-delay="100"] {
        transition-delay: var(--duration-500);           /* 0.5s → var(--duration-500) */
    }
    
    .fullscreen-menu.active .overlay-nav a[data-delay="200"] {
        transition-delay: calc(var(--duration-500) + var(--duration-100)); /* 0.6s */
    }
    
    .fullscreen-menu.active .overlay-nav a[data-delay="300"] {
        transition-delay: calc(var(--duration-500) + var(--duration-200)); /* 0.7s */
    }
    
    .overlay-nav a:hover {
        background: var(--hover-overlay);                /* rgba(255, 255, 255, 0.08) → token */
        transform: translateY(calc(-1 * var(--space-1))); /* -1px → token */
        text-shadow: 0 var(--space-2) var(--space-4) var(--text-shadow-color, rgba(0, 0, 0, 0.7));
        color: var(--text-primary);                      /* white → dinámico */
        border-left-color: transparent;
        /* ✅ Sin transición específica en hover - usa la del elemento base */
    }
    
    /* === SECCIÓN DE IDIOMAS EN MOBILE === */
    .mobile-language-section {
        margin-top: var(--space-8);                      /* 2rem → var(--space-8) */
        padding-top: var(--space-8);                     /* 2rem → var(--space-8) */
        border-top: var(--border-1) solid var(--glass-border); /* rgba(244, 162, 97, 0.3) → token */
        opacity: 0;
        transform: translateY(var(--space-5));           /* 20px → var(--space-5) */
        transition: all var(--duration-500) var(--ease-out); /* 0.6s ease → tokens */
    }
    
    .fullscreen-menu.active .mobile-language-section {
        opacity: 1;
        transform: translateY(0);
        transition-delay: calc(var(--duration-500) + var(--duration-300)); /* 0.8s */
    }
    
    .mobile-language-title {
        color: var(--accent-primary);                    /* rgba(244, 162, 97, 0.9) → token */
        font-size: var(--text-base);                     /* 1rem → var(--text-base) */
        font-weight: var(--font-semibold);               /* 600 → var(--font-semibold) */
        margin-bottom: var(--space-4);                   /* 1rem → var(--space-4) */
        text-transform: uppercase;
        letter-spacing: var(--tracking-wide);            /* 1px → var(--tracking-wide) */
    }

    /* === VARIABLES DE TEMA === */
    :root {
        --text-shadow-color: rgba(0, 0, 0, 0.7);
    }

    :root[data-theme="light"],
    html[data-theme="light"] {
        --text-shadow-color: rgba(255, 255, 255, 0.7);
    }
    
    /* === RESPONSIVE === */
    @media (max-width: 768px) {
        .left-content {
            top: var(--space-4);                         /* 1rem → var(--space-4) */
            left: var(--space-8);                        /* 2rem → var(--space-8) */
        }
        
        .overlay-logo {
            margin-top: var(--space-1);                  /* 0.25rem → var(--space-1) */
        }
        
        .logo-container {
            height: 80px;
            width: 120px;
        }

        .mini-logo {
            height: 80px;
            max-width: 120px;
        }
        
        .overlay-nav a {
            font-size: var(--text-lg);                   /* 1.4rem → var(--text-lg) */
            letter-spacing: var(--tracking-normal);      /* 0.5px → var(--tracking-normal) */
        }
        
        .close-btn {
            font-size: var(--text-3xl);                  /* 3rem → var(--text-3xl) */
            width: 40px;
            height: 40px;
            top: var(--space-6);                         /* 1.5rem → var(--space-6) */
            right: var(--space-6);                       /* 1.5rem → var(--space-6) */
        }
    }
    
    @media (max-width: 420px) {
        .overlay-nav a {
            font-size: var(--text-base);                 /* 1.2rem → var(--text-base) */
            padding: var(--space-2) var(--space-4);      /* 0.6rem 1rem → tokens */
        }
        
        .overlay-logo {
            margin-bottom: var(--space-8);               /* 2rem → var(--space-8) */
            margin-top: var(--space-1);                  /* 0.25rem → var(--space-1) */
        }
        
        .logo-container {
            height: 80px;
            width: 120px;
        }

        .mini-logo {
            height: 80px;
            max-width: 120px;
        }
        
        .left-content {
            top: var(--space-3);                         /* 0.75rem → var(--space-3) */
            left: var(--space-6);                        /* 1.5rem → var(--space-6) */
        }
    }

    /* === VARIANTES DE TEMA === */
    
    /* Tema claro - overlay más sutil para ver el fondo */
    :root[data-theme="light"] .fullscreen-menu,
    html[data-theme="light"] .fullscreen-menu {
        background: rgba(255, 255, 255, 0.45);
        backdrop-filter: blur(25px) saturate(180%);
    }
    
    :root[data-theme="light"] .overlay-nav a,
    html[data-theme="light"] .overlay-nav a {
        color: var(--text-primary);
        text-shadow: 0 var(--space-1) var(--space-2) rgba(255, 255, 255, 0.9);
    }
    
    :root[data-theme="light"] .overlay-nav a:hover,
    html[data-theme="light"] .overlay-nav a:hover {
        background: var(--hover-overlay);
        text-shadow: 0 var(--space-2) var(--space-4) var(--text-shadow-color);
    }

    /* === ACCESIBILIDAD === */
    
    /* Reducir movimiento si el usuario lo prefiere */
    @media (prefers-reduced-motion: reduce) {
        .fullscreen-menu,
        .close-btn,
        .overlay-logo,
        .overlay-nav a,
        .mobile-language-section,
        .mini-logo {
            transition: none;
            animation: none;
        }
        
        .overlay-nav a:hover,
        .close-btn:hover,
        .overlay-logo a:hover .mini-logo {
            transform: none;
        }
        
        .fullscreen-menu.active .close-btn,
        .fullscreen-menu.active .overlay-logo,
        .fullscreen-menu.active .overlay-nav a,
        .fullscreen-menu.active .mobile-language-section {
            transition-delay: 0s;
        }
    }
    
    /* Alto contraste */
    @media (prefers-contrast: high) {
        .fullscreen-menu {
            background: var(--bg-primary);               /* Fondo sólido */
            backdrop-filter: none;
        }
        
        .overlay-nav a {
            border: var(--border-1) solid transparent;
        }
        
        .overlay-nav a:hover {
            border-color: var(--accent-primary);
            background: var(--accent-light);
        }
        
        .close-btn:hover {
            background: var(--accent-light);
            border: var(--border-1) solid var(--accent-primary);
        }

        .logo-dark {
            filter: drop-shadow(0 var(--space-4) var(--space-12) rgba(0, 0, 0, 1));
        }
        
        .logo-light {
            filter: drop-shadow(0 var(--space-4) var(--space-12) rgba(255, 255, 255, 1));
        }
    }

    /* === MEJORAS DE RENDIMIENTO === */
    
    .fullscreen-menu {
        contain: layout style paint;
        will-change: opacity, visibility;
    }
    
    .mini-logo,
    .overlay-nav a {
        will-change: transform, opacity;
        backface-visibility: hidden;
    }

    /* === ESTADOS ADICIONALES === */
    
    /* Estado de carga */
    .fullscreen-menu.loading {
        pointer-events: none;
    }
    
    .fullscreen-menu.loading .overlay-nav a {
        opacity: 0.5;
    }
</style>

<script>
    import ThemeService from "../../services/ThemeService";

    // Función para actualizar los mini-logos según el tema
    function updateMobileLogosForTheme(theme) {
        const logosDark = document.querySelectorAll('.mini-logo[data-logo="dark"]');
        const logosLight = document.querySelectorAll('.mini-logo[data-logo="light"]');
        
        if (theme === 'light') {
            logosDark.forEach(logo => logo.style.opacity = '0');
            logosLight.forEach(logo => logo.style.opacity = '1');
        } else {
            logosDark.forEach(logo => logo.style.opacity = '1');
            logosLight.forEach(logo => logo.style.opacity = '0');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Inicializar ThemeService si no está inicializado
        if (!ThemeService.currentTheme) {
            ThemeService.initialize();
        }

        // Actualizar logos al cargar
        updateMobileLogosForTheme(ThemeService.getCurrentTheme());

        // Suscribirse a cambios de tema
        ThemeService.onThemeChange((event) => {
            updateMobileLogosForTheme(event.theme);
        });
    });

    // Para navegación SPA en Astro
    document.addEventListener('astro:page-load', () => {
        if (ThemeService.currentTheme) {
            updateMobileLogosForTheme(ThemeService.getCurrentTheme());
        }
    });
</script>